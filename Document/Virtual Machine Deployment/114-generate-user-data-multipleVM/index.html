<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="https://belajarpowershell.github.io/kubernetes-lab/Document/Virtual%20Machine%20Deployment/114-generate-user-data-multipleVM/" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>114 generate user data multipleVM - Kubernetes Lab setup</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "114 generate user data multipleVM";
        var mkdocs_page_input_path = "Document/Virtual Machine Deployment/114-generate-user-data-multipleVM.md";
        var mkdocs_page_url = "/kubernetes-lab/Document/Virtual%20Machine%20Deployment/114-generate-user-data-multipleVM/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> Kubernetes Lab setup
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">Welcome to MkDocs</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Document</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../../">Index</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../scratch/">nfs for ubuntu</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Introduction</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Introduction/000-ReadMeFirst/">000 ReadMeFirst</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Introduction/001-High-Level-node-setup/">Kubernetes lab setup - High level reference.</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Introduction/001-Hyper-V-Host-Specification/">Hyper-V-Host-Specification</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../Introduction/001-Hyper-V-VM-creation/">Hyper-V Virtual Machine Powershell script</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Pre Requisites</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../Pre%20Requisites/002-vi-basics/">002 vi basics</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Virtual Machine Deployment</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../113-New-single-VM-setup-Ubuntu-autoinstall/">alpine1 setup and configuration.</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="./">114 generate user data multipleVM</a>
    <ul class="current">
    </ul>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../114-generate-user-data-reference/">114 generate user data reference</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Alpine1</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/100-alpine1-setup/">Initial Alpine OS setup - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/101-DHCP-server/">Install and Configure DHCP - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/102-setup-router/">Configure as a Router  -alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/103-setup-dns/">Configure DNS server - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/104-setup-nginx/">Install and Configure nginx - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/105-nfs/">Install and Configure nfs- alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/106-tftp/">Install and Configure tftpd - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/107-cloud-init/">Install and Configure cloud-init - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/108-DHCP-for-PXE/">update DHCP options to provide PXE boot information to clients. - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/109-setup-boot-files-part1/">Part 1 of 4  Setup boot files for PXELINUX and OS boot- alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/110-setup-boot-files-part2-PXE/">Part 2 of 4  Setup boot files for PXELINUX - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/111-setup-boot-files-part3-OS/">Part 3 of 4 Setup OS Boot files - alpine1</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../alpine1/112-setup-boot-files-part4-pxelinux.cfg/">Part 4 of 4 Configure the boot menu pxelinux.cfg/default - alpine1</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">Draft</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../draft/200-setup-alpine-LB/">Setup Alpine Load balancer</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../draft/9108-alpine1-setup-pxe-bootmenu%20copy/">alpine1 setup and configuration.</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../draft/9108-alpine1-setup-pxe-bootmenu/">alpine1 setup and configuration.</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../draft/999-alpine1-DHCP-set-hostname/">alpine1 setup and configuration.</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../draft/argo-cd/">Argo cd</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../draft/kubernetes-upgrade/">Kubernetes upgrade</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="#">Ad login</a>
    <ul>
                <li class="toctree-l3"><a class="reference internal" href="../../draft/ad-login/001-k3s-setup/">001 k3s setup</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../draft/ad-login/azure-ad-setup/">Azure ad setup</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../draft/ad-login/entra-app-registration-aks-cli-kubectl/">Entra app registration aks cli kubectl</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../draft/ad-login/kubectl-kubelogin/">Kubectl kubelogin</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../draft/ad-login/kubectl-login-ad/">Kubectl login ad</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../draft/ad-login/test-ad-authentication/">Test ad authentication</a>
                </li>
                <li class="toctree-l3"><a class="reference internal" href="../../draft/ad-login/windows-install-az-cli/">Windows install az cli</a>
                </li>
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="#">K3s deployment</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../k3s-deployment/200-Ansible-setup/">200 Ansible setup</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../k3s-deployment/201-k3s-setup/">201 k3s setup</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">Kubernetes Lab setup</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Document</li>
          <li class="breadcrumb-item">Virtual Machine Deployment</li>
      <li class="breadcrumb-item active">114 generate user data multipleVM</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h3 id="generate-user-data-mac-address-file">Generate <code>user-data-mac-address</code> file.</h3>
<p>For a Kubernetes cluster we will need multiple Virtual Machines. This will require multiple <code>user-data-mac-address</code> files to be created. Here I use PowerShellt to generate the files.</p>
<p>To setup each Hyper-V VM with the Ubuntu Operating system we need to generate unique <code>user-data</code> files. The following script generates the script based on a working <code>user-data</code> file. This working file was extracted by installing Ubuntu from scratch with the relevant configurations. This file can be obtained from <code>/var/log/installer/autoinstall-user-data</code>. This file is renamed as <code>user-data-template.yaml</code> in this script. The script then creates new files based on the mac-address with the hostname and IP address updated.  </p>
<pre><code class="language-powershell"># Get the directory containing the script
$scriptDirectory = Split-Path -Parent $MyInvocation.MyCommand.Path

# Set the path to the script file
Set-Location $scriptDirectory
$output = &quot;$scriptDirectory\autoinstall&quot;
if ((Test-Path -Path $output) -ne &quot;True&quot;) { New-Item -Path $output -ItemType Directory }

# Define a hashtable for mapping hostnames to IP addresses
$ipAddressMap = @{
    &quot;alpine1&quot;       = &quot;192.168.100.201&quot;
    &quot;loadbalancer&quot;  = &quot;192.168.100.202&quot;
    &quot;master1&quot;       = &quot;192.168.100.203&quot;
    &quot;master2&quot;       = &quot;192.168.100.204&quot;
    &quot;master3&quot;       = &quot;192.168.100.205&quot;
    &quot;worker1&quot;       = &quot;192.168.100.206&quot;
    &quot;worker2&quot;       = &quot;192.168.100.207&quot;
    &quot;worker3&quot;       = &quot;192.168.100.208&quot;
    &quot;xsinglenode&quot;   = &quot;192.168.100.209&quot;
    &quot;xsingleubuntu&quot; = &quot;192.168.100.210&quot;
}

# Get all virtual machines
$vms = Get-VM

# Iterate through each virtual machine
foreach ($vm in $vms) {
    # Get MAC address of the first network adapter
    $macAddress = $vm | Get-VMNetworkAdapter | Select-Object -First 1 | Select-Object -ExpandProperty MacAddress

    # Remove &quot;k8s-&quot; prefix from the VM name
    $vmName = $vm.Name -replace '^k8s-', ''

    # Format MAC address
    $formattedMacAddress = ($macAddress -replace '(.{2})(.{2})(.{2})(.{2})(.{2})(.{2})', '$1-$2-$3-$4-$5-$6').ToLower()

    # Get IP address from the mapping
    $ipAddress = $ipAddressMap[$vmName]

    if (-not $ipAddress) {
        Write-Host &quot;Error: IP address not found for '$vmName'.&quot;
        continue
    }

    # Format DHCP configuration
    $dhcpConfig = @&quot;
host $vmName {
    hardware ethernet $formattedMacAddress;
    fixed-address $ipAddress;
    option host-name &quot;$vmName&quot;;
}
&quot;@
    Write-Host &quot;----------------------&quot;
    # Output results
   # Write-Host &quot;VM Name: $vmName&quot;
   # Write-Host &quot;MAC Address: $formattedMacAddress&quot;
    Write-Host &quot;IP Address: $ipAddress&quot;
   # Write-Host &quot;Server Name: $($env:COMPUTERNAME)&quot;


    # Write to the CSV file
    $mac = &quot; $vmName,$formattedMacAddress,$ipAddress&quot;
    Write-Host $mac
    $mac | Out-File $output\mac-address-list.csv -Append

    # Create user-data files
    # Create user-data files
    $userDataFile = &quot;$output\user-data-$formattedMacAddress&quot;

    if (-not (Test-Path $userDataFile)) {
        # File doesn't exist, create it by copying the template
        Copy-Item -Path &quot;user-data-template.yaml&quot; -Destination $userDataFile
        Write-Host &quot;File created: $userDataFile&quot;
    }
    #this following file is to be able to identify the mac address with hostname directly from the filename
    if (-not (Test-Path $userdatafile-$vmName)) {
    # File doesn't exist, create it
    New-Item -ItemType File -Path $userdatafile-$vmName 
    Write-Host &quot;File created: $userdatafile-$vmName&quot;
} 
    # Get content of the template file
    $userDataContent = Get-Content -Path $userDataFile -Raw

    # Replace the placeholders with predetermined values
    $userDataContent = $userDataContent -replace 'hostname: master1', &quot;hostname: $vmName&quot;
    $userDataContent = $userDataContent -replace '192.168.100.202/24', &quot;$ipAddress/24&quot;

    # Set the modified content back to the user-data file
    Set-Content -Path $userDataFile -Value $userDataContent
    Write-Host &quot;----------------------&quot;

}

</code></pre>
<p>This script references 2 different files <code>user-data-early</code> and another for <code>user-data-template</code>.</p>
<p>These 2 files have some differences. </p>
<p><code>user-data</code>  </p>
<ul>
<li>
<p>On row 2 contains the entry <code>autoinstall:</code> </p>
</li>
<li>
<p>On row 28 and 29 contains the early command . This is when the file <code>user-data-mac-address</code> is downloaded to <code>autoinstall.yaml</code></p>
</li>
</ul>
<p><code>user-data-early
    early-commands:
      - curl -G -o /autoinstall.yaml http://192.168.100.1/autoinstall/user-data-"$(ip a | grep ether | awk '{print $2}' | tr ':' '-')"</code></p>
<p><code>user-data-template</code></p>
<ul>
<li>Does not have the  <code>autoinstall:</code>  entry. Having this entry will cause the installation to fail.</li>
<li>Does not have the early command to download the <code>user-data-template</code> as this was already done.</li>
</ul>
<p>The generated files are in the subfolder  <code>.\autoinstall\</code></p>
<p><img alt="114-01-location-of-script" src="G:\kubernetes-lab\kubernetes-lab-setup\Document\screenshots\114-01-location-of-script.png" /></p>
<p>From the configuration in step 112 , the Boot sequence is looking up the location. <code>http://192.168.100.1/autoinstall/</code></p>
<p>This is from the following code</p>
<pre><code>APPEND netboot=nfs boot=casper root=/dev/nfs nfsroot=192.168.100.1:/srv/isoubuntu autoinstall 
</code></pre>
<p>Copy the files created to the folder </p>
<p><code>/srv/autoinstall/</code> on the <code>alpine1</code> server. The duplicate file with the node name is workaround to show the hostname of the specific file. As I did not find away to identify the hostname using the Ubuntu autoinstall method.</p>
<p><img alt="114-02-wsftp-cp-autoinstall" src="G:\kubernetes-lab\kubernetes-lab-setup\Document\screenshots\114-02-wsftp-cp-autoinstall.png" /></p>
<p>If you recall from 104-setup-nginx, the folder /srv/ was exposed to be visible from <code>http://192.168.100.1/</code>. All folders created in <code>/srv/</code> will be listed via the browser.</p>
<p>Copy the files using WSFTP or some other method . </p>
<p>Validate by browsing <code>http://192.168.100.1/</code></p>
<p><img alt="114-03-list-autoinstall-in-browser" src="G:\kubernetes-lab\kubernetes-lab-setup\Document\screenshots\114-03-list-autoinstall-in-browser.png" /></p>
<p>To update Video of Script generation and the Ubuntu setup.</p>
<p>, <code>vendor-data</code> </p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../113-New-single-VM-setup-Ubuntu-autoinstall/" class="btn btn-neutral float-left" title="alpine1 setup and configuration."><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../114-generate-user-data-reference/" class="btn btn-neutral float-right" title="114 generate user data reference">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
      <p>&copy; 2024 <a href="https://github.com/belajarpowershell"  target="_blank" rel="noopener">Suresh Solomon</a></p>
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../113-New-single-VM-setup-Ubuntu-autoinstall/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../114-generate-user-data-reference/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
